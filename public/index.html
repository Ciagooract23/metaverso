<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetaChat</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="metaverso.jpg" type="image/x-icon">
</head>
<body>
  <div id="sidebar">
    <header>Utenti Online</header>
    <ul id="userList"></ul>
  </div>
  <div id="chat">
    <header>
      <div class="chat-title">Metaverso</div>
    </header>
    <div id="messages"></div>
    <div id="typingStatus"></div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="Scrivi un messaggio..." autocomplete="off" />
      <button id="sendButton" title="Invia Messaggio">Invia</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
     const socket = io();

  // Chiede il nome utente
  let username = prompt("Inserisci il tuo nome:");
  if (!username) {
    alert("Devi inserire un nome per partecipare alla chat.");
    location.reload();
  }
  socket.emit('new user', username);

  // Elementi della UI
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const messagesDiv = document.getElementById('messages');
  const userList = document.getElementById('userList');

  // Funzione per inviare un messaggio
  function sendMessage() {
    const text = messageInput.value.trim();
    if (text !== "") {
      socket.emit('new message', text);  // Invia al server
      messageInput.value = "";           // Pulisce campo
    }
  }

  // Invia messaggio con click su "Invia"
  sendButton.addEventListener('click', sendMessage);

  // Invia messaggio con "Enter"
  messageInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      sendMessage();
    }
  });

  // Ricezione di nuovi messaggi
  socket.on('new message', (data) => {
    const msgElem = document.createElement('div');

    if (data.username === username) {
      msgElem.classList.add('message', 'self');  // Messaggio tuo
    } else {
      msgElem.classList.add('message', 'other'); // Messaggio ricevuto
      msgElem.setAttribute('data-username', data.username);
    }

    msgElem.textContent = data.message;
    messagesDiv.appendChild(msgElem);
    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll automatico
  });

  // Aggiorna la lista degli utenti online
  socket.on('update users', (users) => {
    userList.innerHTML = "";
    users.forEach((user) => {
      const li = document.createElement('li');
      li.textContent = user;
      userList.appendChild(li);
    });
  });
  </script>
</body>
</html>
